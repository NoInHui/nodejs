<div style="color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 마이크로태스크</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 프라미스 핸들러 .then / catch / finally 는 항상 비동기적으로 실행됩니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 프라미스가 즉시 이행되더라도 .then / catch / finally 아래에 있는 코드는 이 핸들러들이 실행되기 전에 실행됩니다.</span></div><br><div><span style="color: rgb(86, 156, 214); font-size: 10pt;">let</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">promise</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> = </span><span style="color: rgb(86, 156, 214); font-size: 10pt;">new</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(78, 201, 176); font-size: 10pt;">Promise</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">((</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">resolve</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">, </span><span style="color: rgb(220, 220, 170); font-size: 10pt;">reject</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">) </span><span style="color: rgb(86, 156, 214); font-size: 10pt;">=&gt;</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> {</span></div><div><span style="color: rgb(212, 212, 212); font-size: 10pt;">&nbsp; &nbsp; </span><span style="color: rgb(220, 220, 170); font-size: 10pt;">resolve</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(206, 145, 120); font-size: 10pt;">'promise success'</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">);</span></div><div><span style="color: rgb(212, 212, 212); font-size: 10pt;">});</span></div><div><span style="color: rgb(156, 220, 254); font-size: 10pt;">promise</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">.</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">then</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(156, 220, 254); font-size: 10pt;">result</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(86, 156, 214); font-size: 10pt;">=&gt;</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">console</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">.</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">log</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(156, 220, 254); font-size: 10pt;">result</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">));</span></div><div><span style="color: rgb(197, 134, 192); font-size: 10pt;">for</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(86, 156, 214); font-size: 10pt;">let</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">i</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> = </span><span style="color: rgb(181, 206, 168); font-size: 10pt;">0</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">; </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">i</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">&lt;</span><span style="color: rgb(181, 206, 168); font-size: 10pt;">1000</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">; </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">i</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">++) {</span></div><div><span style="color: rgb(212, 212, 212); font-size: 10pt;">&nbsp; &nbsp; </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">console</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">.</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">log</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(206, 145, 120); font-size: 10pt;">'after1'</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">);</span></div><div><span style="color: rgb(212, 212, 212); font-size: 10pt;">}</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 실행결과</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// after * 1000</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// promise success</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 마이크로태스크 큐</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 비동기 작업을 처리하려면 적절한 관리가 필요합니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 이를 위해 ECMA 에선 PromiseJobs 라는 내부 큐(internal queue) 를 명시합니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// V8 엔진에선 이를 '마이크로태스크 큐(microtask queue)' 라고 부르기 때문에 이 용어가 좀 더 선호됩니다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 명세서의 설명을 살펴봅시다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 마이크로태스크 큐는 먼저 들어온 작업을 먼저 실행합니다. (FIFO, first in first out)</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 실행할 것이 아무것도 남아있지 않을 때만 마이크로태스크 큐에 있는 작업이 실행되기 시작합니다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 요약하자면, 어떤 프라미스가 준비되었을 때 이 프라미스의 .then/catch/finally 핸들러가 큐에 들어간다고 생각하시면 됩니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 이때 핸들러들은 여전히 실행되지 않습니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 현재 코드에서 자유로운 상태가 되었을 때에서야 자바스크립트 엔진은 큐에서 작업을 꺼내 실행합니다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 프라미스 핸들러는 항상 내부 큐를 통과하게 됩니다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 여러 개의 .then / catch / finally 를 사용해 만든 체인의 경우, 각 핸들러는 비동기적으로 실행됩니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 큐에 들어간 핸들러 각각은 현재 코드가 완료되고, 큐에 적제된 이전 핸들러의 실행이 완료되었을 떄 실행됩니다.</span></div><br><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 처리되지 못한 거부</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 프라미스와 에러 핸들링에서 학습한 unhandledrejection 이벤트를 기억하고 계시나요?</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 이제 자바스크립트 엔진이 어떻게 처리되지 못한 거부(unhandled rejection)를 찾는지 정확히 알 수 있습니다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 처리되지 못한 거부는 마이크로태스크 큐 끝에서 프라미스 에러가 처리되지 못할 때 발생합니다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 정상적인 경우라면 개발자는 에러가 생길 것을 대비하여 프라미스 체인에 .catch 를 추가해 에러를 &nbsp;처리합니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 그런데 .catch 를 추가해주는 걸 잊은 경우, 엔진은 마이크로태스크 큐가 빈 이후에 unhandledrejection 이벤트를 트리거 합니다.</span></div><br><div><span style="color: rgb(86, 156, 214); font-size: 10pt;">let</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">promise2</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> = </span><span style="color: rgb(86, 156, 214); font-size: 10pt;">new</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(78, 201, 176); font-size: 10pt;">Promise</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">((</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">resolve</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">, </span><span style="color: rgb(220, 220, 170); font-size: 10pt;">reject</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">) </span><span style="color: rgb(86, 156, 214); font-size: 10pt;">=&gt;</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(220, 220, 170); font-size: 10pt;">reject</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(86, 156, 214); font-size: 10pt;">new</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(78, 201, 176); font-size: 10pt;">Error</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(206, 145, 120); font-size: 10pt;">'error'</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">)));</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// promise2.catch(e =&gt; console.log(e));</span></div><br><div><span style="color: rgb(156, 220, 254); font-size: 10pt;">window</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">.</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">addEventListener</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(206, 145, 120); font-size: 10pt;">'unhandledrejection'</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">, </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">e</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(86, 156, 214); font-size: 10pt;">=&gt;</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">console</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">.</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">log</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(206, 145, 120); font-size: 10pt;">'unhandledrejection'</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">, </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">e</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">));</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 그런데 만약 아래와 같이 setTimeout 을 이용해 에러를 나중에 처리하면 어떤 일이 생길까요?</span></div><br><div><span style="color: rgb(86, 156, 214); font-size: 10pt;">let</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">promise3</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> = </span><span style="color: rgb(78, 201, 176); font-size: 10pt;">Promise</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">.</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">reject</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(86, 156, 214); font-size: 10pt;">new</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(78, 201, 176); font-size: 10pt;">Error</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(206, 145, 120); font-size: 10pt;">'error'</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">));</span></div><div><span style="color: rgb(220, 220, 170); font-size: 10pt;">setTimeout</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(() </span><span style="color: rgb(86, 156, 214); font-size: 10pt;">=&gt;</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">promise3</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">.</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">catch</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(156, 220, 254); font-size: 10pt;">e</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(86, 156, 214); font-size: 10pt;">=&gt;</span><span style="color: rgb(212, 212, 212); font-size: 10pt;"> </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">console</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">.</span><span style="color: rgb(220, 220, 170); font-size: 10pt;">log</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">(</span><span style="color: rgb(206, 145, 120); font-size: 10pt;">'catch error'</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">, </span><span style="color: rgb(156, 220, 254); font-size: 10pt;">e</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">)), </span><span style="color: rgb(181, 206, 168); font-size: 10pt;">1000</span><span style="color: rgb(212, 212, 212); font-size: 10pt;">);</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 마이크로태스크 큐에 대해 몰랐다면 '에러를 잡았는데도 왜 unhandledrejection 핸들러가 실행되는 거지?' 라는 의문을 가졌을 겁니다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// unhandledrejection 은 마이크로태스크 큐에 있는 작업 모두가 완료되었을 때 생성됩니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 엔진은 프라미스들을 검사하고 이 중 하나라도 거부(rejected) 상태이면 unhandledrejection 핸들러를 트리거 하죠.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 위 예시를 실행하면 setTimeout 을 사용해 추가한 .catch 역시 트리거 됩니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 다만 .catch 는 unhandledrejection 이 발생한 이후에 트리거 됩니다.</span></div><br><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 요약</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 모든 프라미스 동작은 '마이크로태스크 큐' 라 불리는 내부 '프라미스 잡' 큐에 들어가서 처리되기 때문에 프라미스 핸들링은 항상 비동기로 처리됩니다.</span></div><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 따라서 .then / catch / finally 핸들러는 항상 현재 코드가 종료되고 난 후에 호출됩니다.</span></div><br><div><span style="color: rgb(106, 153, 85); font-size: 10pt;">// 어떤 코드 조각을 .then / catch / finally 가 호출된 이후에 실행하고 싶다면 .then 을 체인에 추가하고 이 안에 코드 조각을 넣으면 됩니다.</span></div></div>